# 🚀 Sorry Cypress 阿里云快速部署指南

## 📋 部署前准备

### 1. 阿里云 ECS 实例
- **实例规格**: 2核4GB 或 4核8GB
- **操作系统**: Ubuntu 20.04/22.04
- **带宽**: 5Mbps 以上
- **存储**: 40GB 系统盘 + 100GB 数据盘

### 2. 域名准备
- 准备一个域名（如：`cypress.yourdomain.com`）
- 将域名解析到阿里云 ECS 实例的公网 IP

### 3. 安全组配置
在阿里云控制台配置安全组，开放以下端口：
```
入方向规则:
- 端口 22 (SSH)
- 端口 80 (HTTP)
- 端口 443 (HTTPS)
- 端口 1234 (Director)
- 端口 4000 (API)
- 端口 8080 (Dashboard)
- 端口 9000 (MinIO API)
- 端口 9090 (MinIO Console)
```

## 🚀 一键部署

### 方法一：使用部署脚本（推荐）

1. **连接到阿里云 ECS 实例**
   ```bash
   ssh root@your-server-ip
   ```

2. **下载部署脚本**
   ```bash
   wget https://raw.githubusercontent.com/your-repo/sorry-cypress/main/deploy-to-aliyun.sh
   chmod +x deploy-to-aliyun.sh
   ```

3. **运行部署脚本**
   ```bash
   ./deploy-to-aliyun.sh
   ```

4. **按提示输入配置信息**
   - 域名：`cypress.yourdomain.com`
   - 项目密钥：`your-project-key-1,your-project-key-2`
   - MongoDB 密码：`your-secure-mongo-password`
   - MinIO 密钥：`your-secure-minio-secret`

### 方法二：手动部署

1. **更新系统并安装依赖**
   ```bash
   sudo apt update && sudo apt upgrade -y
   sudo apt install curl wget git -y
   ```

2. **安装 Docker**
   ```bash
   curl -fsSL https://get.docker.com -o get-docker.sh
   sudo sh get-docker.sh
   sudo usermod -aG docker $USER
   ```

3. **安装 Docker Compose**
   ```bash
   sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose
   ```

4. **创建项目目录**
   ```bash
   sudo mkdir -p /opt/sorry-cypress
   sudo chown $USER:$USER /opt/sorry-cypress
   cd /opt/sorry-cypress
   mkdir -p data/{mongo,minio}
   ```

5. **下载配置文件**
   ```bash
   wget https://raw.githubusercontent.com/your-repo/sorry-cypress/main/docker-compose.prod.yml
   ```

6. **修改配置文件**
   ```bash
   # 编辑 docker-compose.prod.yml，替换以下变量：
   # - your-domain.com -> 你的域名
   # - your-secure-password -> MongoDB 密码
   # - your-minio-secret -> MinIO 密钥
   # - your-project-key-1,your-project-key-2 -> 项目密钥
   nano docker-compose.prod.yml
   ```

7. **启动服务**
   ```bash
   docker-compose -f docker-compose.prod.yml up -d
   ```

## 🔧 配置 Nginx 反向代理

### 1. 安装 Nginx
```bash
sudo apt install nginx -y
sudo systemctl enable nginx
sudo systemctl start nginx
```

### 2. 创建 Nginx 配置
```bash
sudo nano /etc/nginx/sites-available/sorry-cypress
```

### 3. 配置内容
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # Dashboard
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API
    location /api/ {
        proxy_pass http://localhost:4000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Director
    location /director/ {
        proxy_pass http://localhost:1234/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MinIO Console
    location /minio/ {
        proxy_pass http://localhost:9090/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 4. 启用配置
```bash
sudo ln -s /etc/nginx/sites-available/sorry-cypress /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx
```

## 🔒 配置 SSL 证书

### 1. 安装 Certbot
```bash
sudo apt install certbot python3-certbot-nginx -y
```

### 2. 获取 SSL 证书
```bash
sudo certbot --nginx -d your-domain.com
```

### 3. 设置自动续期
```bash
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

## 📊 验证部署

### 1. 检查服务状态
```bash
cd /opt/sorry-cypress
docker-compose -f docker-compose.prod.yml ps
```

### 2. 查看服务日志
```bash
docker-compose -f docker-compose.prod.yml logs -f
```

### 3. 测试访问
- Dashboard: https://your-domain.com
- API: https://your-domain.com/api
- Director: https://your-domain.com/director
- MinIO Console: https://your-domain.com/minio

## 🔧 客户端配置

### 1. 创建 Cypress 配置文件
```javascript
// cypress.config.prod.js
const { defineConfig } = require('cypress')

module.exports = defineConfig({
  e2e: {
    setupNodeEvents(on, config) {
      // implement node event listeners here
    },
  },
  env: {
    sorryCypressUrl: 'https://your-domain.com/director',
    recordKey: 'your-project-key-1'
  }
})
```

### 2. 运行测试
```bash
npx cypress run --config-file cypress.config.prod.js
```

## 🛠️ 管理命令

### 服务管理
```bash
# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f

# 重启服务
docker-compose -f docker-compose.prod.yml restart

# 停止服务
docker-compose -f docker-compose.prod.yml down

# 更新服务
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d
```

### 数据备份
```bash
# 备份 MongoDB 数据
docker exec sorry-cypress-mongo-1 mongodump --out /data/backup

# 备份 MinIO 数据
cp -r /opt/sorry-cypress/data/minio /backup/minio

# 备份配置文件
cp /opt/sorry-cypress/docker-compose.prod.yml /backup/
```

## 📈 监控和维护

### 1. 系统监控
```bash
# 查看系统资源使用情况
htop
df -h
free -h

# 查看 Docker 资源使用情况
docker stats
```

### 2. 日志监控
```bash
# 查看 Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 查看 Docker 日志
docker-compose -f docker-compose.prod.yml logs -f director
```

### 3. 性能优化
```bash
# 清理 Docker 镜像
docker system prune -a

# 清理日志文件
sudo journalctl --vacuum-time=7d
```

## 🔐 安全配置

### 1. 防火墙配置
```bash
# 安装 UFW
sudo apt install ufw -y

# 配置防火墙规则
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

### 2. 定期更新
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 更新 Docker 镜像
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d
```

## 📞 故障排除

### 常见问题

1. **服务无法启动**
   ```bash
   # 查看详细错误信息
   docker-compose -f docker-compose.prod.yml logs
   
   # 检查端口占用
   sudo netstat -tlnp | grep :1234
   ```

2. **SSL 证书问题**
   ```bash
   # 重新获取证书
   sudo certbot --nginx -d your-domain.com
   
   # 检查证书状态
   sudo certbot certificates
   ```

3. **数据库连接问题**
   ```bash
   # 检查 MongoDB 状态
   docker exec sorry-cypress-mongo-1 mongo --eval "db.adminCommand('ping')"
   
   # 检查网络连接
   docker network ls
   docker network inspect sorry-cypress_sorry-cypress-network
   ```

## 💰 成本估算

### 阿里云 ECS 费用（每月）
- **2核4GB 实例**: 约 200-300 元
- **4核8GB 实例**: 约 400-600 元
- **带宽费用**: 约 50-100 元
- **存储费用**: 约 20-50 元

**总计**: 每月约 300-800 元

## 📚 相关资源

- [阿里云 ECS 文档](https://help.aliyun.com/product/25484.html)
- [Sorry Cypress 官方文档](https://docs.sorry-cypress.dev/)
- [Docker Compose 文档](https://docs.docker.com/compose/)
- [Nginx 配置指南](https://nginx.org/en/docs/)

---

**部署完成时间**: 约 30-60 分钟  
**维护难度**: 中等  
**推荐指数**: ⭐⭐⭐⭐⭐ 