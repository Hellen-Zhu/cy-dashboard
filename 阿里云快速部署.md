# ğŸš€ Sorry Cypress é˜¿é‡Œäº‘å¿«é€Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. é˜¿é‡Œäº‘ ECS å®ä¾‹
- **å®ä¾‹è§„æ ¼**: 2æ ¸4GB æˆ– 4æ ¸8GB
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04/22.04
- **å¸¦å®½**: 5Mbps ä»¥ä¸Š
- **å­˜å‚¨**: 40GB ç³»ç»Ÿç›˜ + 100GB æ•°æ®ç›˜

### 2. åŸŸåå‡†å¤‡
- å‡†å¤‡ä¸€ä¸ªåŸŸåï¼ˆå¦‚ï¼š`cypress.yourdomain.com`ï¼‰
- å°†åŸŸåè§£æåˆ°é˜¿é‡Œäº‘ ECS å®ä¾‹çš„å…¬ç½‘ IP

### 3. å®‰å…¨ç»„é…ç½®
åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°é…ç½®å®‰å…¨ç»„ï¼Œå¼€æ”¾ä»¥ä¸‹ç«¯å£ï¼š
```
å…¥æ–¹å‘è§„åˆ™:
- ç«¯å£ 22 (SSH)
- ç«¯å£ 80 (HTTP)
- ç«¯å£ 443 (HTTPS)
- ç«¯å£ 1234 (Director)
- ç«¯å£ 4000 (API)
- ç«¯å£ 8080 (Dashboard)
- ç«¯å£ 9000 (MinIO API)
- ç«¯å£ 9090 (MinIO Console)
```

## ğŸš€ ä¸€é”®éƒ¨ç½²

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

1. **è¿æ¥åˆ°é˜¿é‡Œäº‘ ECS å®ä¾‹**
   ```bash
   ssh root@your-server-ip
   ```

2. **ä¸‹è½½éƒ¨ç½²è„šæœ¬**
   ```bash
   wget https://raw.githubusercontent.com/your-repo/sorry-cypress/main/deploy-to-aliyun.sh
   chmod +x deploy-to-aliyun.sh
   ```

3. **è¿è¡Œéƒ¨ç½²è„šæœ¬**
   ```bash
   ./deploy-to-aliyun.sh
   ```

4. **æŒ‰æç¤ºè¾“å…¥é…ç½®ä¿¡æ¯**
   - åŸŸåï¼š`cypress.yourdomain.com`
   - é¡¹ç›®å¯†é’¥ï¼š`your-project-key-1,your-project-key-2`
   - MongoDB å¯†ç ï¼š`your-secure-mongo-password`
   - MinIO å¯†é’¥ï¼š`your-secure-minio-secret`

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

1. **æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ä¾èµ–**
   ```bash
   sudo apt update && sudo apt upgrade -y
   sudo apt install curl wget git -y
   ```

2. **å®‰è£… Docker**
   ```bash
   curl -fsSL https://get.docker.com -o get-docker.sh
   sudo sh get-docker.sh
   sudo usermod -aG docker $USER
   ```

3. **å®‰è£… Docker Compose**
   ```bash
   sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose
   ```

4. **åˆ›å»ºé¡¹ç›®ç›®å½•**
   ```bash
   sudo mkdir -p /opt/sorry-cypress
   sudo chown $USER:$USER /opt/sorry-cypress
   cd /opt/sorry-cypress
   mkdir -p data/{mongo,minio}
   ```

5. **ä¸‹è½½é…ç½®æ–‡ä»¶**
   ```bash
   wget https://raw.githubusercontent.com/your-repo/sorry-cypress/main/docker-compose.prod.yml
   ```

6. **ä¿®æ”¹é…ç½®æ–‡ä»¶**
   ```bash
   # ç¼–è¾‘ docker-compose.prod.ymlï¼Œæ›¿æ¢ä»¥ä¸‹å˜é‡ï¼š
   # - your-domain.com -> ä½ çš„åŸŸå
   # - your-secure-password -> MongoDB å¯†ç 
   # - your-minio-secret -> MinIO å¯†é’¥
   # - your-project-key-1,your-project-key-2 -> é¡¹ç›®å¯†é’¥
   nano docker-compose.prod.yml
   ```

7. **å¯åŠ¨æœåŠ¡**
   ```bash
   docker-compose -f docker-compose.prod.yml up -d
   ```

## ğŸ”§ é…ç½® Nginx åå‘ä»£ç†

### 1. å®‰è£… Nginx
```bash
sudo apt install nginx -y
sudo systemctl enable nginx
sudo systemctl start nginx
```

### 2. åˆ›å»º Nginx é…ç½®
```bash
sudo nano /etc/nginx/sites-available/sorry-cypress
```

### 3. é…ç½®å†…å®¹
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # Dashboard
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API
    location /api/ {
        proxy_pass http://localhost:4000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Director
    location /director/ {
        proxy_pass http://localhost:1234/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MinIO Console
    location /minio/ {
        proxy_pass http://localhost:9090/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 4. å¯ç”¨é…ç½®
```bash
sudo ln -s /etc/nginx/sites-available/sorry-cypress /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx
```

## ğŸ”’ é…ç½® SSL è¯ä¹¦

### 1. å®‰è£… Certbot
```bash
sudo apt install certbot python3-certbot-nginx -y
```

### 2. è·å– SSL è¯ä¹¦
```bash
sudo certbot --nginx -d your-domain.com
```

### 3. è®¾ç½®è‡ªåŠ¨ç»­æœŸ
```bash
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œ
0 12 * * * /usr/bin/certbot renew --quiet
```

## ğŸ“Š éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
cd /opt/sorry-cypress
docker-compose -f docker-compose.prod.yml ps
```

### 2. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
```bash
docker-compose -f docker-compose.prod.yml logs -f
```

### 3. æµ‹è¯•è®¿é—®
- Dashboard: https://your-domain.com
- API: https://your-domain.com/api
- Director: https://your-domain.com/director
- MinIO Console: https://your-domain.com/minio

## ğŸ”§ å®¢æˆ·ç«¯é…ç½®

### 1. åˆ›å»º Cypress é…ç½®æ–‡ä»¶
```javascript
// cypress.config.prod.js
const { defineConfig } = require('cypress')

module.exports = defineConfig({
  e2e: {
    setupNodeEvents(on, config) {
      // implement node event listeners here
    },
  },
  env: {
    sorryCypressUrl: 'https://your-domain.com/director',
    recordKey: 'your-project-key-1'
  }
})
```

### 2. è¿è¡Œæµ‹è¯•
```bash
npx cypress run --config-file cypress.config.prod.js
```

## ğŸ› ï¸ ç®¡ç†å‘½ä»¤

### æœåŠ¡ç®¡ç†
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# åœæ­¢æœåŠ¡
docker-compose -f docker-compose.prod.yml down

# æ›´æ–°æœåŠ¡
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d
```

### æ•°æ®å¤‡ä»½
```bash
# å¤‡ä»½ MongoDB æ•°æ®
docker exec sorry-cypress-mongo-1 mongodump --out /data/backup

# å¤‡ä»½ MinIO æ•°æ®
cp -r /opt/sorry-cypress/data/minio /backup/minio

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp /opt/sorry-cypress/docker-compose.prod.yml /backup/
```

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### 1. ç³»ç»Ÿç›‘æ§
```bash
# æŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
htop
df -h
free -h

# æŸ¥çœ‹ Docker èµ„æºä½¿ç”¨æƒ…å†µ
docker stats
```

### 2. æ—¥å¿—ç›‘æ§
```bash
# æŸ¥çœ‹ Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# æŸ¥çœ‹ Docker æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f director
```

### 3. æ€§èƒ½ä¼˜åŒ–
```bash
# æ¸…ç† Docker é•œåƒ
docker system prune -a

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
sudo journalctl --vacuum-time=7d
```

## ğŸ” å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™é…ç½®
```bash
# å®‰è£… UFW
sudo apt install ufw -y

# é…ç½®é˜²ç«å¢™è§„åˆ™
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

### 2. å®šæœŸæ›´æ–°
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# æ›´æ–° Docker é•œåƒ
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d
```

## ğŸ“ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æœåŠ¡æ— æ³•å¯åŠ¨**
   ```bash
   # æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
   docker-compose -f docker-compose.prod.yml logs
   
   # æ£€æŸ¥ç«¯å£å ç”¨
   sudo netstat -tlnp | grep :1234
   ```

2. **SSL è¯ä¹¦é—®é¢˜**
   ```bash
   # é‡æ–°è·å–è¯ä¹¦
   sudo certbot --nginx -d your-domain.com
   
   # æ£€æŸ¥è¯ä¹¦çŠ¶æ€
   sudo certbot certificates
   ```

3. **æ•°æ®åº“è¿æ¥é—®é¢˜**
   ```bash
   # æ£€æŸ¥ MongoDB çŠ¶æ€
   docker exec sorry-cypress-mongo-1 mongo --eval "db.adminCommand('ping')"
   
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   docker network ls
   docker network inspect sorry-cypress_sorry-cypress-network
   ```

## ğŸ’° æˆæœ¬ä¼°ç®—

### é˜¿é‡Œäº‘ ECS è´¹ç”¨ï¼ˆæ¯æœˆï¼‰
- **2æ ¸4GB å®ä¾‹**: çº¦ 200-300 å…ƒ
- **4æ ¸8GB å®ä¾‹**: çº¦ 400-600 å…ƒ
- **å¸¦å®½è´¹ç”¨**: çº¦ 50-100 å…ƒ
- **å­˜å‚¨è´¹ç”¨**: çº¦ 20-50 å…ƒ

**æ€»è®¡**: æ¯æœˆçº¦ 300-800 å…ƒ

## ğŸ“š ç›¸å…³èµ„æº

- [é˜¿é‡Œäº‘ ECS æ–‡æ¡£](https://help.aliyun.com/product/25484.html)
- [Sorry Cypress å®˜æ–¹æ–‡æ¡£](https://docs.sorry-cypress.dev/)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [Nginx é…ç½®æŒ‡å—](https://nginx.org/en/docs/)

---

**éƒ¨ç½²å®Œæˆæ—¶é—´**: çº¦ 30-60 åˆ†é’Ÿ  
**ç»´æŠ¤éš¾åº¦**: ä¸­ç­‰  
**æ¨èæŒ‡æ•°**: â­â­â­â­â­ 