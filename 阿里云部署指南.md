# Sorry Cypress é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ–¹æ¡ˆæ¦‚è¿°

å°† Sorry Cypress ä»æœ¬åœ° Docker éƒ¨ç½²è¿ç§»åˆ°é˜¿é‡Œäº‘ï¼Œå®ç°äº‘ç«¯ç®¡ç†å’Œèµ„æºä¼˜åŒ–ã€‚

## ğŸ—ï¸ éƒ¨ç½²æ¶æ„

```
é˜¿é‡Œäº‘ ECS å®ä¾‹
â”œâ”€â”€ Sorry Cypress Director (ç«¯å£ 1234)
â”œâ”€â”€ Sorry Cypress API (ç«¯å£ 4000)
â”œâ”€â”€ Sorry Cypress Dashboard (ç«¯å£ 8080)
â”œâ”€â”€ MongoDB (ç«¯å£ 27017)
â”œâ”€â”€ MinIO (ç«¯å£ 9000/9090)
â””â”€â”€ Nginx åå‘ä»£ç† (ç«¯å£ 80/443)
```

## ğŸ”§ æ–¹æ¡ˆä¸€ï¼šé˜¿é‡Œäº‘ ECS + Docker Compose

### 1. å‡†å¤‡é˜¿é‡Œäº‘ ECS å®ä¾‹

#### å®ä¾‹é…ç½®å»ºè®®
- **å®ä¾‹è§„æ ¼**: 2æ ¸4GB æˆ– 4æ ¸8GB
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04/22.04 æˆ– CentOS 7/8
- **å¸¦å®½**: 5Mbps ä»¥ä¸Š
- **å­˜å‚¨**: 40GB ç³»ç»Ÿç›˜ + 100GB æ•°æ®ç›˜

#### å®‰å…¨ç»„é…ç½®
```
å…¥æ–¹å‘è§„åˆ™:
- ç«¯å£ 22 (SSH)
- ç«¯å£ 80 (HTTP)
- ç«¯å£ 443 (HTTPS)
- ç«¯å£ 1234 (Director)
- ç«¯å£ 4000 (API)
- ç«¯å£ 8080 (Dashboard)
- ç«¯å£ 9000 (MinIO API)
- ç«¯å£ 9090 (MinIO Console)
```

### 2. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

#### å®‰è£… Docker å’Œ Docker Compose

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# å®‰è£… Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# é‡å¯ Docker æœåŠ¡
sudo systemctl enable docker
sudo systemctl start docker
```

#### å®‰è£… Nginx

```bash
# å®‰è£… Nginx
sudo apt install nginx -y

# å¯åŠ¨ Nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```

### 3. åˆ›å»ºéƒ¨ç½²ç›®å½•

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /opt/sorry-cypress
cd /opt/sorry-cypress

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p data/{mongo,minio}
```

### 4. åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®

#### docker-compose.prod.yml

```yaml
version: '3.8'

services:
  mongo:
    image: mongo:4.4
    environment:
      MONGO_INITDB_ROOT_USERNAME: 'admin'
      MONGO_INITDB_ROOT_PASSWORD: 'your-secure-password'
    volumes:
      - ./data/mongo:/data/db
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  director:
    image: agoldis/sorry-cypress-director:latest
    environment:
      DASHBOARD_URL: https://your-domain.com
      EXECUTION_DRIVER: '../execution/mongo/driver'
      MONGODB_URI: 'mongodb://admin:your-secure-password@mongo:27017'
      MONGODB_DATABASE: 'sorry-cypress'
      SCREENSHOTS_DRIVER: '../screenshots/minio.driver'
      MINIO_ACCESS_KEY: 'minioadmin'
      MINIO_SECRET_KEY: 'your-minio-secret'
      MINIO_ENDPOINT: 'minio'
      MINIO_URL: 'http://minio:9000'
      MINIO_PORT: '9000'
      MINIO_USESSL: 'false'
      MINIO_BUCKET: sorry-cypress
      ALLOWED_KEYS: 'your-project-key-1,your-project-key-2'
      PROBE_LOGGER: "false"
    ports:
      - "1234:1234"
    depends_on:
      - mongo
      - minio
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  api:
    image: agoldis/sorry-cypress-api:latest
    environment:
      MONGODB_URI: 'mongodb://admin:your-secure-password@mongo:27017'
      MONGODB_DATABASE: 'sorry-cypress'
      APOLLO_PLAYGROUND: 'false'
    ports:
      - "4000:4000"
    depends_on:
      - mongo
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  dashboard:
    image: agoldis/sorry-cypress-dashboard:latest
    environment:
      GRAPHQL_SCHEMA_URL: http://api:4000
      GRAPHQL_CLIENT_CREDENTIALS: ''
      PORT: 8080
      CI_URL: ''
    ports:
      - "8080:8080"
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  minio:
    image: minio/minio
    environment:
      MINIO_ROOT_USER: 'minioadmin'
      MINIO_ROOT_PASSWORD: 'your-minio-secret'
    volumes:
      - ./data/minio:/data
    command: minio server --console-address ":9090" /data
    ports:
      - "9000:9000"
      - "9090:9090"
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  createbuckets:
    image: minio/mc
    network_mode: service:minio
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      /usr/bin/mc alias set myminio http://localhost:9000 minioadmin your-minio-secret;
      /usr/bin/mc mb myminio/sorry-cypress || true;
      /usr/bin/mc anonymous set download myminio/sorry-cypress;
      /usr/bin/mc anonymous set public myminio/sorry-cypress;
      exit 0;
      "

networks:
  sorry-cypress-network:
    driver: bridge
```

### 5. é…ç½® Nginx åå‘ä»£ç†

#### /etc/nginx/sites-available/sorry-cypress

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # Dashboard
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API
    location /api/ {
        proxy_pass http://localhost:4000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Director
    location /director/ {
        proxy_pass http://localhost:1234/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MinIO Console
    location /minio/ {
        proxy_pass http://localhost:9090/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### å¯ç”¨ç«™ç‚¹é…ç½®

```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/sorry-cypress /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

### 6. é…ç½® SSL è¯ä¹¦

#### å®‰è£… Certbot

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx -y

# è·å– SSL è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œ
0 12 * * * /usr/bin/certbot renew --quiet
```

### 7. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
cd /opt/sorry-cypress
docker-compose -f docker-compose.prod.yml up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f
```

## ğŸ—ï¸ æ–¹æ¡ˆäºŒï¼šé˜¿é‡Œäº‘å®¹å™¨æœåŠ¡ ACK

### 1. åˆ›å»º Kubernetes é›†ç¾¤

#### é›†ç¾¤é…ç½®
- **é›†ç¾¤ç±»å‹**: æ‰˜ç®¡ç‰ˆ Kubernetes
- **èŠ‚ç‚¹è§„æ ¼**: 2æ ¸4GB
- **èŠ‚ç‚¹æ•°é‡**: 2-3ä¸ª
- **ç½‘ç»œæ’ä»¶**: Flannel

### 2. åˆ›å»º Kubernetes é…ç½®æ–‡ä»¶

#### sorry-cypress-namespace.yaml

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: sorry-cypress
```

#### sorry-cypress-configmap.yaml

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sorry-cypress-config
  namespace: sorry-cypress
data:
  MONGODB_URI: "mongodb://admin:your-secure-password@mongo:27017"
  MONGODB_DATABASE: "sorry-cypress"
  DASHBOARD_URL: "https://your-domain.com"
  ALLOWED_KEYS: "your-project-key-1,your-project-key-2"
```

#### sorry-cypress-secret.yaml

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: sorry-cypress-secret
  namespace: sorry-cypress
type: Opaque
data:
  MONGODB_PASSWORD: eW91ci1zZWN1cmUtcGFzc3dvcmQ=  # base64 encoded
  MINIO_SECRET: eW91ci1taW5pby1zZWNyZXQ=  # base64 encoded
```

### 3. éƒ¨ç½²æœåŠ¡

```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl apply -f sorry-cypress-namespace.yaml

# åˆ›å»ºé…ç½®
kubectl apply -f sorry-cypress-configmap.yaml
kubectl apply -f sorry-cypress-secret.yaml

# éƒ¨ç½²æœåŠ¡
kubectl apply -f sorry-cypress-deployment.yaml
kubectl apply -f sorry-cypress-service.yaml
kubectl apply -f sorry-cypress-ingress.yaml
```

## ğŸ”§ æ–¹æ¡ˆä¸‰ï¼šé˜¿é‡Œäº‘å‡½æ•°è®¡ç®— FC

### 1. åˆ›å»ºå‡½æ•°è®¡ç®—æœåŠ¡

#### æœåŠ¡é…ç½®
- **è¿è¡Œæ—¶**: Node.js 16
- **å†…å­˜**: 512MB
- **è¶…æ—¶æ—¶é—´**: 60ç§’

### 2. éƒ¨ç½² API å‡½æ•°

```javascript
// index.js
const { ApolloServer } = require('apollo-server-express');
const express = require('express');

const app = express();

// Sorry Cypress API é€»è¾‘
// ...

exports.handler = (req, res) => {
  // å¤„ç†è¯·æ±‚
};
```

## ğŸ“Š æˆæœ¬å¯¹æ¯”

### æœ¬åœ°éƒ¨ç½²
- **ç¡¬ä»¶æˆæœ¬**: 0ï¼ˆä½¿ç”¨ç°æœ‰è®¾å¤‡ï¼‰
- **ç”µè´¹**: æ¯æœˆçº¦ 50-100 å…ƒ
- **ç»´æŠ¤æˆæœ¬**: éœ€è¦è‡ªå·±ç»´æŠ¤

### é˜¿é‡Œäº‘ ECS éƒ¨ç½²
- **å®ä¾‹è´¹ç”¨**: æ¯æœˆçº¦ 200-500 å…ƒï¼ˆ2æ ¸4GBï¼‰
- **å¸¦å®½è´¹ç”¨**: æ¯æœˆçº¦ 50-100 å…ƒ
- **å­˜å‚¨è´¹ç”¨**: æ¯æœˆçº¦ 20-50 å…ƒ
- **ç»´æŠ¤æˆæœ¬**: è¾ƒä½ï¼Œé˜¿é‡Œäº‘æä¾›åŸºç¡€ç»´æŠ¤

### é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡
- **é›†ç¾¤è´¹ç”¨**: æ¯æœˆçº¦ 300-800 å…ƒ
- **èŠ‚ç‚¹è´¹ç”¨**: æ¯æœˆçº¦ 200-500 å…ƒ
- **è´Ÿè½½å‡è¡¡**: æ¯æœˆçº¦ 50-100 å…ƒ
- **ç»´æŠ¤æˆæœ¬**: æœ€ä½ï¼Œå®Œå…¨æ‰˜ç®¡

## ğŸ” å®‰å…¨é…ç½®

### 1. ç½‘ç»œå®‰å…¨
- é…ç½®å®‰å…¨ç»„ï¼Œåªå¼€æ”¾å¿…è¦ç«¯å£
- ä½¿ç”¨ VPC ç½‘ç»œéš”ç¦»
- é…ç½® WAF é˜²æŠ¤

### 2. æ•°æ®å®‰å…¨
- ä½¿ç”¨å¼ºå¯†ç 
- å®šæœŸå¤‡ä»½æ•°æ®
- å¯ç”¨æ•°æ®åŠ å¯†

### 3. è®¿é—®æ§åˆ¶
- é…ç½® ALLOWED_KEYS
- ä½¿ç”¨ IAM è§’è‰²
- å®šæœŸè½®æ¢å¯†é’¥

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### 1. é˜¿é‡Œäº‘ç›‘æ§
- é…ç½®äº‘ç›‘æ§å‘Šè­¦
- ç›‘æ§ CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡
- è®¾ç½®æ—¥å¿—åˆ†æ

### 2. åº”ç”¨ç›‘æ§
- ä½¿ç”¨é˜¿é‡Œäº‘ ARMS ç›‘æ§åº”ç”¨æ€§èƒ½
- é…ç½®é”™è¯¯å‘Šè­¦
- ç›‘æ§ API å“åº”æ—¶é—´

## ğŸš€ éƒ¨ç½²è„šæœ¬

### ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash

# é˜¿é‡Œäº‘ä¸€é”®éƒ¨ç½²è„šæœ¬
echo "ğŸš€ å¼€å§‹éƒ¨ç½² Sorry Cypress åˆ°é˜¿é‡Œäº‘..."

# 1. æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# 2. å®‰è£… Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 3. å®‰è£… Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 4. åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /opt/sorry-cypress
cd /opt/sorry-cypress

# 5. ä¸‹è½½é…ç½®æ–‡ä»¶
wget https://raw.githubusercontent.com/your-repo/sorry-cypress/main/docker-compose.prod.yml

# 6. å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸŒ Dashboard: https://your-domain.com"
echo "ğŸ”§ API: https://your-domain.com/api"
echo "ğŸ“Š MinIO: https://your-domain.com/minio"
```

## ğŸ“š ç›¸å…³èµ„æº

- [é˜¿é‡Œäº‘ ECS æ–‡æ¡£](https://help.aliyun.com/product/25484.html)
- [é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡æ–‡æ¡£](https://help.aliyun.com/product/85222.html)
- [Sorry Cypress å®˜æ–¹æ–‡æ¡£](https://docs.sorry-cypress.dev/)

---

**æ›´æ–°æ—¶é—´**: 2025-07-27  
**éƒ¨ç½²æ–¹æ¡ˆ**: é˜¿é‡Œäº‘ ECS + Docker Compose  
**æˆæœ¬é¢„ä¼°**: æ¯æœˆ 300-600 å…ƒ 