# Sorry Cypress 阿里云部署指南

## 📋 部署方案概述

将 Sorry Cypress 从本地 Docker 部署迁移到阿里云，实现云端管理和资源优化。

## 🏗️ 部署架构

```
阿里云 ECS 实例
├── Sorry Cypress Director (端口 1234)
├── Sorry Cypress API (端口 4000)
├── Sorry Cypress Dashboard (端口 8080)
├── MongoDB (端口 27017)
├── MinIO (端口 9000/9090)
└── Nginx 反向代理 (端口 80/443)
```

## 🔧 方案一：阿里云 ECS + Docker Compose

### 1. 准备阿里云 ECS 实例

#### 实例配置建议
- **实例规格**: 2核4GB 或 4核8GB
- **操作系统**: Ubuntu 20.04/22.04 或 CentOS 7/8
- **带宽**: 5Mbps 以上
- **存储**: 40GB 系统盘 + 100GB 数据盘

#### 安全组配置
```
入方向规则:
- 端口 22 (SSH)
- 端口 80 (HTTP)
- 端口 443 (HTTPS)
- 端口 1234 (Director)
- 端口 4000 (API)
- 端口 8080 (Dashboard)
- 端口 9000 (MinIO API)
- 端口 9090 (MinIO Console)
```

### 2. 服务器环境准备

#### 安装 Docker 和 Docker Compose

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 重启 Docker 服务
sudo systemctl enable docker
sudo systemctl start docker
```

#### 安装 Nginx

```bash
# 安装 Nginx
sudo apt install nginx -y

# 启动 Nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```

### 3. 创建部署目录

```bash
# 创建项目目录
mkdir -p /opt/sorry-cypress
cd /opt/sorry-cypress

# 创建数据目录
mkdir -p data/{mongo,minio}
```

### 4. 创建生产环境配置

#### docker-compose.prod.yml

```yaml
version: '3.8'

services:
  mongo:
    image: mongo:4.4
    environment:
      MONGO_INITDB_ROOT_USERNAME: 'admin'
      MONGO_INITDB_ROOT_PASSWORD: 'your-secure-password'
    volumes:
      - ./data/mongo:/data/db
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  director:
    image: agoldis/sorry-cypress-director:latest
    environment:
      DASHBOARD_URL: https://your-domain.com
      EXECUTION_DRIVER: '../execution/mongo/driver'
      MONGODB_URI: 'mongodb://admin:your-secure-password@mongo:27017'
      MONGODB_DATABASE: 'sorry-cypress'
      SCREENSHOTS_DRIVER: '../screenshots/minio.driver'
      MINIO_ACCESS_KEY: 'minioadmin'
      MINIO_SECRET_KEY: 'your-minio-secret'
      MINIO_ENDPOINT: 'minio'
      MINIO_URL: 'http://minio:9000'
      MINIO_PORT: '9000'
      MINIO_USESSL: 'false'
      MINIO_BUCKET: sorry-cypress
      ALLOWED_KEYS: 'your-project-key-1,your-project-key-2'
      PROBE_LOGGER: "false"
    ports:
      - "1234:1234"
    depends_on:
      - mongo
      - minio
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  api:
    image: agoldis/sorry-cypress-api:latest
    environment:
      MONGODB_URI: 'mongodb://admin:your-secure-password@mongo:27017'
      MONGODB_DATABASE: 'sorry-cypress'
      APOLLO_PLAYGROUND: 'false'
    ports:
      - "4000:4000"
    depends_on:
      - mongo
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  dashboard:
    image: agoldis/sorry-cypress-dashboard:latest
    environment:
      GRAPHQL_SCHEMA_URL: http://api:4000
      GRAPHQL_CLIENT_CREDENTIALS: ''
      PORT: 8080
      CI_URL: ''
    ports:
      - "8080:8080"
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  minio:
    image: minio/minio
    environment:
      MINIO_ROOT_USER: 'minioadmin'
      MINIO_ROOT_PASSWORD: 'your-minio-secret'
    volumes:
      - ./data/minio:/data
    command: minio server --console-address ":9090" /data
    ports:
      - "9000:9000"
      - "9090:9090"
    restart: unless-stopped
    networks:
      - sorry-cypress-network

  createbuckets:
    image: minio/mc
    network_mode: service:minio
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      /usr/bin/mc alias set myminio http://localhost:9000 minioadmin your-minio-secret;
      /usr/bin/mc mb myminio/sorry-cypress || true;
      /usr/bin/mc anonymous set download myminio/sorry-cypress;
      /usr/bin/mc anonymous set public myminio/sorry-cypress;
      exit 0;
      "

networks:
  sorry-cypress-network:
    driver: bridge
```

### 5. 配置 Nginx 反向代理

#### /etc/nginx/sites-available/sorry-cypress

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # Dashboard
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API
    location /api/ {
        proxy_pass http://localhost:4000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Director
    location /director/ {
        proxy_pass http://localhost:1234/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # MinIO Console
    location /minio/ {
        proxy_pass http://localhost:9090/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 启用站点配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/sorry-cypress /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 6. 配置 SSL 证书

#### 安装 Certbot

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取 SSL 证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

### 7. 启动服务

```bash
# 启动所有服务
cd /opt/sorry-cypress
docker-compose -f docker-compose.prod.yml up -d

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

## 🏗️ 方案二：阿里云容器服务 ACK

### 1. 创建 Kubernetes 集群

#### 集群配置
- **集群类型**: 托管版 Kubernetes
- **节点规格**: 2核4GB
- **节点数量**: 2-3个
- **网络插件**: Flannel

### 2. 创建 Kubernetes 配置文件

#### sorry-cypress-namespace.yaml

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: sorry-cypress
```

#### sorry-cypress-configmap.yaml

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: sorry-cypress-config
  namespace: sorry-cypress
data:
  MONGODB_URI: "mongodb://admin:your-secure-password@mongo:27017"
  MONGODB_DATABASE: "sorry-cypress"
  DASHBOARD_URL: "https://your-domain.com"
  ALLOWED_KEYS: "your-project-key-1,your-project-key-2"
```

#### sorry-cypress-secret.yaml

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: sorry-cypress-secret
  namespace: sorry-cypress
type: Opaque
data:
  MONGODB_PASSWORD: eW91ci1zZWN1cmUtcGFzc3dvcmQ=  # base64 encoded
  MINIO_SECRET: eW91ci1taW5pby1zZWNyZXQ=  # base64 encoded
```

### 3. 部署服务

```bash
# 创建命名空间
kubectl apply -f sorry-cypress-namespace.yaml

# 创建配置
kubectl apply -f sorry-cypress-configmap.yaml
kubectl apply -f sorry-cypress-secret.yaml

# 部署服务
kubectl apply -f sorry-cypress-deployment.yaml
kubectl apply -f sorry-cypress-service.yaml
kubectl apply -f sorry-cypress-ingress.yaml
```

## 🔧 方案三：阿里云函数计算 FC

### 1. 创建函数计算服务

#### 服务配置
- **运行时**: Node.js 16
- **内存**: 512MB
- **超时时间**: 60秒

### 2. 部署 API 函数

```javascript
// index.js
const { ApolloServer } = require('apollo-server-express');
const express = require('express');

const app = express();

// Sorry Cypress API 逻辑
// ...

exports.handler = (req, res) => {
  // 处理请求
};
```

## 📊 成本对比

### 本地部署
- **硬件成本**: 0（使用现有设备）
- **电费**: 每月约 50-100 元
- **维护成本**: 需要自己维护

### 阿里云 ECS 部署
- **实例费用**: 每月约 200-500 元（2核4GB）
- **带宽费用**: 每月约 50-100 元
- **存储费用**: 每月约 20-50 元
- **维护成本**: 较低，阿里云提供基础维护

### 阿里云容器服务
- **集群费用**: 每月约 300-800 元
- **节点费用**: 每月约 200-500 元
- **负载均衡**: 每月约 50-100 元
- **维护成本**: 最低，完全托管

## 🔐 安全配置

### 1. 网络安全
- 配置安全组，只开放必要端口
- 使用 VPC 网络隔离
- 配置 WAF 防护

### 2. 数据安全
- 使用强密码
- 定期备份数据
- 启用数据加密

### 3. 访问控制
- 配置 ALLOWED_KEYS
- 使用 IAM 角色
- 定期轮换密钥

## 📈 监控和日志

### 1. 阿里云监控
- 配置云监控告警
- 监控 CPU、内存、磁盘使用率
- 设置日志分析

### 2. 应用监控
- 使用阿里云 ARMS 监控应用性能
- 配置错误告警
- 监控 API 响应时间

## 🚀 部署脚本

### 一键部署脚本

```bash
#!/bin/bash

# 阿里云一键部署脚本
echo "🚀 开始部署 Sorry Cypress 到阿里云..."

# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 安装 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 3. 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 4. 创建项目目录
mkdir -p /opt/sorry-cypress
cd /opt/sorry-cypress

# 5. 下载配置文件
wget https://raw.githubusercontent.com/your-repo/sorry-cypress/main/docker-compose.prod.yml

# 6. 启动服务
docker-compose -f docker-compose.prod.yml up -d

echo "✅ 部署完成！"
echo "🌐 Dashboard: https://your-domain.com"
echo "🔧 API: https://your-domain.com/api"
echo "📊 MinIO: https://your-domain.com/minio"
```

## 📚 相关资源

- [阿里云 ECS 文档](https://help.aliyun.com/product/25484.html)
- [阿里云容器服务文档](https://help.aliyun.com/product/85222.html)
- [Sorry Cypress 官方文档](https://docs.sorry-cypress.dev/)

---

**更新时间**: 2025-07-27  
**部署方案**: 阿里云 ECS + Docker Compose  
**成本预估**: 每月 300-600 元 