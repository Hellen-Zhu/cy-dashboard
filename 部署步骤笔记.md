# Sorry Cypress 本地部署步骤笔记

## 📋 项目概述

Sorry Cypress 是一个开源的 Cypress Dashboard 替代方案，提供：
- 无限制的并行测试执行
- 截图和视频上传到自己的存储
- 测试结果浏览
- 自托管解决方案
- GitHub、Slack 等集成

## 🏗️ 系统架构

项目包含以下核心服务：
- **Director**: 测试执行协调器 (端口 1234)
- **API**: GraphQL API 服务 (端口 4000)
- **Dashboard**: Web 界面 (端口 8081)
- **MongoDB**: 数据存储 (端口 27017)
- **MinIO**: 文件存储服务 (端口 9000/9090)

## 🚀 部署步骤

### 步骤 1: 环境检查

```bash
# 检查 Docker 版本
docker --version

# 检查 Docker Compose 版本
docker-compose --version

# 检查当前目录
pwd
# 应该显示: /Users/hellen/cypress/sorry-cypress
```

### 步骤 2: 创建本地配置文件

```bash
# 复制 MinIO 配置文件作为本地配置
cp docker-compose.minio.yml docker-compose.local.yml
```

**配置文件说明**:
- 使用 `docker-compose.minio.yml` 作为基础
- 包含完整的存储解决方案
- 支持截图和视频存储

### 步骤 3: 修改配置文件

需要修改以下配置项：

#### MongoDB 配置
```yaml
mongo:
  environment:
    MONGO_INITDB_ROOT_USERNAME: 'admin'
    MONGO_INITDB_ROOT_PASSWORD: 'password'
```

#### Director 服务配置
```yaml
director:
  environment:
    DASHBOARD_URL: http://localhost:8081  # 修改端口避免冲突
    MONGODB_URI: 'mongodb://admin:password@mongo:27017'
    MINIO_ACCESS_KEY: 'minioadmin'
    MINIO_SECRET_KEY: 'minioadmin'
    MINIO_ENDPOINT: 'localhost'
    MINIO_URL: 'http://localhost'
```

#### API 服务配置
```yaml
api:
  environment:
    MONGODB_URI: 'mongodb://admin:password@mongo:27017'
    MONGODB_DATABASE: 'sorry-cypress'
```

#### Dashboard 服务配置
```yaml
dashboard:
  ports:
    - 8081:8080  # 修改外部端口避免冲突
  environment:
    GRAPHQL_SCHEMA_URL: http://localhost:4000
```

#### MinIO 存储配置
```yaml
storage:
  environment:
    MINIO_ROOT_USER: 'minioadmin'
    MINIO_ROOT_PASSWORD: 'minioadmin'
```

### 步骤 4: 创建数据目录

```bash
# 创建 MongoDB 数据目录
mkdir -p data/data-mongo-cypress

# 创建 MinIO 数据目录
mkdir -p data/data-minio-cypress

# 验证目录创建
ls -la data/
```

### 步骤 5: 启动服务

```bash
# 启动所有服务
docker-compose -f docker-compose.local.yml up -d

# 查看启动状态
docker-compose -f docker-compose.local.yml ps
```

**预期输出**:
```
NAME                        STATUS         PORTS
sorry-cypress-api-1         Up 4 seconds   0.0.0.0:4000->4000/tcp
sorry-cypress-dashboard-1   Up 4 seconds   0.0.0.0:8081->8080/tcp
sorry-cypress-director-1    Up 4 seconds   0.0.0.0:1234->1234/tcp, 0.0.0.0:9000->9000/tcp, 0.0.0.0:9090->9090/tcp
sorry-cypress-mongo-1       Up 4 seconds   0.0.0.0:27017->27017/tcp
```

### 步骤 6: 验证服务状态

```bash
# 检查服务日志
docker-compose -f docker-compose.local.yml logs --tail=20

# 测试服务响应
curl -s -o /dev/null -w "%{http_code}" http://localhost:8081  # Dashboard
curl -s -o /dev/null -w "%{http_code}" http://localhost:4000  # API
curl -s -o /dev/null -w "%{http_code}" http://localhost:1234  # Director
```

**预期响应码**:
- Dashboard: 200
- API: 400 (GraphQL 端点)
- Director: 302 (重定向)

## 📊 服务访问地址

| 服务 | 地址 | 说明 |
|------|------|------|
| Dashboard | http://localhost:8081 | Web 管理界面 |
| API | http://localhost:4000 | GraphQL API |
| Director | http://localhost:1234 | 测试协调器 |
| MinIO 控制台 | http://localhost:9090 | 文件存储管理 |
| MinIO API | http://localhost:9000 | 文件存储 API |
| MongoDB | localhost:27017 | 数据库 |

## 🔐 登录凭据

| 服务 | 用户名 | 密码 |
|------|--------|------|
| MongoDB | admin | password |
| MinIO | minioadmin | minioadmin |

## 🛠️ 服务管理命令

### 查看服务状态
```bash
docker-compose -f docker-compose.local.yml ps
```

### 查看服务日志
```bash
# 查看所有服务日志
docker-compose -f docker-compose.local.yml logs

# 查看特定服务日志
docker-compose -f docker-compose.local.yml logs dashboard
docker-compose -f docker-compose.local.yml logs api
docker-compose -f docker-compose.local.yml logs director
```

### 重启服务
```bash
# 重启所有服务
docker-compose -f docker-compose.local.yml restart

# 重启特定服务
docker-compose -f docker-compose.local.yml restart dashboard
```

### 停止服务
```bash
docker-compose -f docker-compose.local.yml down
```

### 清理数据
```bash
# 停止服务
docker-compose -f docker-compose.local.yml down

# 删除数据目录（谨慎操作）
rm -rf data/

# 重新创建目录
mkdir -p data/data-mongo-cypress data/data-minio-cypress
```

## 🔧 故障排除

### 端口冲突问题
```bash
# 检查端口占用
lsof -i :8080
lsof -i :4000
lsof -i :1234

# 解决方案：修改 docker-compose.local.yml 中的端口映射
```

### 服务启动失败
```bash
# 查看详细错误日志
docker-compose -f docker-compose.local.yml logs

# 检查 Docker 状态
docker info

# 重启 Docker 服务
```

### 数据持久化问题
```bash
# 检查数据目录权限
ls -la data/

# 重新创建数据目录
mkdir -p data/data-mongo-cypress data/data-minio-cypress
chmod 755 data/
```

## 📝 快速启动脚本

创建 `start-local.sh` 脚本：

```bash
#!/bin/bash

echo "🚀 启动 Sorry Cypress 本地服务..."

# 检查 Docker 是否运行
if ! docker info > /dev/null 2>&1; then
    echo "❌ Docker 未运行，请先启动 Docker"
    exit 1
fi

# 创建数据目录
echo "📁 创建数据目录..."
mkdir -p data/data-mongo-cypress data/data-minio-cypress

# 启动服务
echo "🔧 启动 Docker 服务..."
docker-compose -f docker-compose.local.yml up -d

# 等待服务启动
echo "⏳ 等待服务启动..."
sleep 10

# 检查服务状态
echo "📊 检查服务状态..."
docker-compose -f docker-compose.local.yml ps

echo ""
echo "✅ Sorry Cypress 本地服务已启动！"
echo ""
echo "🌐 访问地址："
echo "   Dashboard: http://localhost:8081"
echo "   API:       http://localhost:4000"
echo "   Director:  http://localhost:1234"
echo "   MinIO:     http://localhost:9090 (用户名: minioadmin, 密码: minioadmin)"
echo ""
echo "🛑 停止服务: docker-compose -f docker-compose.local.yml down"
```

设置执行权限：
```bash
chmod +x start-local.sh
```

## 🎯 使用指南

### 1. 访问 Dashboard
打开浏览器访问 http://localhost:8081

### 2. 创建项目
在 Dashboard 中创建新的测试项目

### 3. 配置 Cypress
在您的 Cypress 项目中安装和配置 sorry-cypress：

```bash
npm install --save-dev sorry-cypress
```

在 `cypress.config.js` 中添加：
```javascript
const { defineConfig } = require('cypress')

module.exports = defineConfig({
  e2e: {
    setupNodeEvents(on, config) {
      // implement node event listeners here
    },
  },
  env: {
    sorryCypressUrl: 'http://localhost:1234'
  }
})
```

### 4. 运行测试
使用 sorry-cypress 运行您的 Cypress 测试

## 📚 相关文档

- [官方文档](https://docs.sorry-cypress.dev)
- [GitHub 仓库](https://github.com/agoldis/sorry-cypress)
- [本地部署说明](LOCAL_DEPLOYMENT.md)

## ✅ 部署完成检查清单

- [ ] Docker 和 Docker Compose 已安装
- [ ] 配置文件已创建和修改
- [ ] 数据目录已创建
- [ ] 所有服务已启动
- [ ] 服务状态检查通过
- [ ] 端口访问正常
- [ ] 登录凭据可用
- [ ] 快速启动脚本已创建

---

**部署时间**: 2025-07-27  
**部署环境**: macOS (darwin 24.5.0)  
**Docker 版本**: 28.3.2  
**项目版本**: 2.6.0 